@model ProyectoFinal_G3.Models.VentaDirecta
@{
    ViewData["Title"] = "Crear Venta Directa";
}

<h2 class="text-white">Crear Venta Directa</h2>

<form asp-action="CrearVenta" method="post" class="row g-3 mb-4">

    <div class="col-md-4">
        <label class="form-label text-white">Cliente</label>
        <select asp-for="Id_Cliente" class="form-select bg-dark text-light border-secondary">
            <option value="">Seleccione cliente</option>
            @foreach (var c in ViewBag.Clientes)
            {
                <option value="@c.Id_Clientes">@c.NombreCliente</option>
            }
        </select>
    </div>

    <div class="col-md-12">
        <label class="form-label text-white">Productos</label>
        <table class="table table-dark table-bordered text-light" id="productosTabla">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Total</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <button type="button" class="btn btn-outline-light" onclick="agregarFila()">Agregar Producto</button>
    </div>

    <div class="col-md-3 mt-3">
        <label class="form-label text-white">Total</label>
        <input type="text" asp-for="Total" id="totalVenta" class="form-control bg-dark text-light border-secondary" readonly />
    </div>

    <div class="col-md-2 mt-3">
        <button type="submit" class="btn btn-outline-success w-100">Generar Venta</button>
    </div>
</form>

@section Scripts {
    <script>
        var productos = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.Productos));

        function agregarFila(){
            var tbody = document.querySelector("#productosTabla tbody");
            var fila = document.createElement("tr");
            fila.innerHTML = `
                <td>
                    <select class="form-select bg-dark text-light border-secondary productoSelect">
                        <option value="">Seleccione</option>
                        ${productos.map(p => `<option value="${p.Id_Inventario}" data-precio="${p.PrecioUnitario}">${p.ProductoNombre}</option>`).join('')}
                    </select>
                </td>
                <td><input type="number" class="form-control bg-dark text-light border-secondary cantidadInput" value="1" min="1"></td>
                <td><input type="text" class="form-control bg-dark text-light border-secondary precioInput" readonly></td>
                <td><input type="text" class="form-control bg-dark text-light border-secondary totalInput" readonly></td>
                <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarFila(this)">Eliminar</button></td>
            `;
            tbody.appendChild(fila);
            actualizarTotales();
            fila.querySelectorAll("select, .cantidadInput").forEach(el => el.addEventListener("change", actualizarTotales));
        }

        function eliminarFila(btn){
            btn.closest("tr").remove();
            actualizarTotales();
        }

        function actualizarTotales(){
            var total = 0;
            document.querySelectorAll("#productosTabla tbody tr").forEach(fila => {
                var productoSelect = fila.querySelector(".productoSelect");
                var cantidad = parseFloat(fila.querySelector(".cantidadInput").value) || 0;
                var precio = parseFloat(productoSelect.selectedOptions[0]?.dataset.precio || 0);
                fila.querySelector(".precioInput").value = precio.toFixed(2);
                fila.querySelector(".totalInput").value = (precio * cantidad).toFixed(2);
                total += precio * cantidad;
            });
            document.getElementById("totalVenta").value = total.toFixed(2);
        }
    </script>
}
