-- Crear la base de datos
CREATE DATABASE CasoEstudioJN;
GO

-- Usar la base de datos
USE CasoEstudioJN;
GO

-- Crear la tabla
CREATE TABLE CasasSistema (
    IdCasa BIGINT IDENTITY(1,1) PRIMARY KEY NOT NULL,
    DescripcionCasa VARCHAR(30) NOT NULL,
    PrecioCasa DECIMAL(10,2) NOT NULL, 
    UsuarioAlquiler VARCHAR(30) NULL,
    FechaAlquiler DATETIME NULL
);


- Consulta a casas en la vista, solo en el rango
CREATE OR ALTER PROCEDURE sp_ConsultarCasas
AS
BEGIN
    SELECT 
        IdCasa,
        DescripcionCasa,
        PrecioCasa,
        UsuarioAlquiler,
        FechaAlquiler,
        CASE 
            WHEN UsuarioAlquiler IS NULL THEN 'Disponible'
            ELSE 'Reservada'
        END AS Estado
    FROM CasasSistema
    WHERE PrecioCasa BETWEEN 115000 AND 180000
    ORDER BY 
        CASE WHEN UsuarioAlquiler IS NULL THEN 1 ELSE 2 END;
END
GO

-- Consulta casas dentro de la vista alquiler, aqui si se listan todas las casas sin filtrar precio
CREATE OR ALTER PROCEDURE sp_CasasDisponibles
AS
BEGIN
    SELECT 
        IdCasa,
        DescripcionCasa,
        PrecioCasa
    FROM CasasSistema
    WHERE UsuarioAlquiler IS NULL
    ORDER BY DescripcionCasa;
END
GO

-- Procedimiento de alquilar casa
CREATE OR ALTER PROCEDURE sp_AlquilarCasa
    @IdCasa BIGINT,
    @UsuarioAlquiler VARCHAR(30),
    @FechaAlquiler DATETIME
AS
BEGIN
    UPDATE CasasSistema
    SET UsuarioAlquiler = @UsuarioAlquiler,
        FechaAlquiler = @FechaAlquiler
    WHERE IdCasa = @IdCasa
      AND UsuarioAlquiler IS NULL;
END
GO

-- Segmento para pruebas!
TRUNCATE TABLE CasasSistema;

INSERT INTO [dbo].[CasasSistema] ([DescripcionCasa],[PrecioCasa],[UsuarioAlquiler],[FechaAlquiler]) 
VALUES ('Casa en San Jos√©',190000,null,null) 
INSERT INTO [dbo].[CasasSistema] ([DescripcionCasa],[PrecioCasa],[UsuarioAlquiler],[FechaAlquiler]) 
VALUES ('Casa en Alajuela',145000,null,null) 
INSERT INTO [dbo].[CasasSistema] ([DescripcionCasa],[PrecioCasa],[UsuarioAlquiler],[FechaAlquiler]) 
VALUES ('Casa en Cartago',115000,null,null) 
INSERT INTO [dbo].[CasasSistema] ([DescripcionCasa],[PrecioCasa],[UsuarioAlquiler],[FechaAlquiler]) 
VALUES ('Casa en Heredia',122000,null,null) 
INSERT INTO [dbo].[CasasSistema] ([DescripcionCasa],[PrecioCasa],[UsuarioAlquiler],[FechaAlquiler]) 
VALUES ('Casa en Guanacaste',105000,null,null) 
